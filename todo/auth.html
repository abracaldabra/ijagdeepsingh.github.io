<html>
  <head>
    <meta http-equiv="cache-control" content="no-cache">
    <script>
    (function(){
      // First, parse the query string
      var params = {}, queryString = location.hash.substring(1),
          regex = /([^&=]+)=([^&]*)/g, m;
      while (m = regex.exec(queryString)) {
        params[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
      }

      // Check if query contains any error messages
      // If yes then redirect to an error page
      if(typeof(params['error']) !== 'undefined'){
        // Access denied
        console.log(typeof(params['error']));
        window.location = params['state'] + '#/errorlogin/200';
      } else {
        // And send the token over to the server
        var req = new XMLHttpRequest();
        // consider using POST so query isn't logged
        // only use # to send query string
        // because we use location.hash to parse
        req.open('GET', 'http://' + window.location.host + '/todo/catchtoken.html#' + queryString, true);

        // Check request status
        // if 200 redirect user to homepage
        // else redirect user to error page
        req.onreadystatechange = function (e) {
          if (req.readyState == 4) {
            if(req.status == 200){
              window.location = params['state'] + '#/home';
          } else{
              // There was an error processing the token.
              window.location = params['state'] + '#errorlogin/' + req.status;
            }
          }
        };
        req.send(null);
      }

    })();
    </script>
  </head>
  <body>
  </body>
</html>